<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>World Fracture</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
    margin:0;
    font-family:'Cinzel', serif;
    background:#111;
    color:#e6d3a3;
    text-align:center;
}

.section{
    margin:20px;
    padding:15px;
    background:#1a1a1a;
    border-radius:10px;
}

button, select{
    margin:5px;
    padding:8px 12px;
    border:none;
    border-radius:6px;
    background:#3a2f1b;
    color:#e6d3a3;
    cursor:pointer;
}

/* Tension */
#tensionRow{
    display:flex;
    flex-wrap:wrap;
    gap:5px;
    justify-content:center;
}

.tensionBox{
    width:20px;
    height:20px;
    border-radius:4px;
    background:#e74c3c;
}

/* Presence */
#presenceBar{
    height:16px;
    width:100%;
    background:#333;
    border-radius:8px;
    overflow:hidden;
}

#presenceFill{
    height:100%;
    width:0%;
    transition:width .3s ease, background .3s ease;
}

/* Modal */
.modal{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:rgba(0,0,0,0.85);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:1000;
}

.modal-content{
    background:#1a1a1a;
    padding:25px;
    border-radius:10px;
    width:90%;
    max-width:500px;
    text-align:left;
    z-index:1001;
}

#eventOptions button{
    display:block;
    width:100%;
    margin:10px 0;
    padding:12px;
    text-align:left;
}

/* Log */
#logContainer{
    max-height:200px;
    overflow-y:auto;
    background:#111;
    padding:10px;
    border-radius:6px;
    text-align:left;
    font-size:0.9em;
}
</style>
</head>
<body>

<h1>WORLD FRACTURE</h1>

<!-- SAVE -->
<div class="section">
<select id="saveSlot">
<option value="slot1">Campaign Slot 1</option>
<option value="slot2">Campaign Slot 2</option>
<option value="slot3">Campaign Slot 3</option>
</select>
<button onclick="saveCampaign()">Save</button>
<button onclick="loadCampaign()">Load</button>
</div>

<!-- ACT -->
<div class="section">
<h2>Current Act</h2>
<select id="actSelector" onchange="switchAct()">
<option value="act1">Act I</option>
<option value="act2">Act II</option>
<option value="act3">Act III</option>
</select>
</div>

<!-- TENSION -->
<div class="section">
<h2>Tension: <span id="tensionValue">0</span></h2>
<div id="tensionRow"></div>
<button onclick="increaseTension()">+Tension</button>
<button onclick="decreaseTension()">-Tension</button>
<button onclick="resetTension()">Reset</button>
</div>

<!-- PRESENCE -->
<div class="section">
<h2>Presence: <span id="presenceValue">0</span></h2>
<div id="presenceBar"><div id="presenceFill"></div></div>
<div>Tier: <span id="presenceTier">Dormant (0–2)</span></div>
<button onclick="changePresence(1)">+1</button>
<button onclick="changePresence(-1)">-1</button>
</div>

<!-- EVENT LOG -->
<div class="section">
<h2>World Log</h2>
<div id="logContainer"></div>
<button onclick="clearLog()">Clear Log</button>
</div>

<!-- MODAL -->
<div class="modal" id="eventModal">
<div class="modal-content">
<h2 id="eventTitle"></h2>
<p id="eventText"></p>
<div id="eventOptions"></div>
</div>
</div>

<script src="events.js"></script>

<script>

let tension=0;
let tensionSinceLastWE=0;
let weCount=0;
let presence=0;
let currentAct="act1";
let usedEventsByAct={act1:[],act2:[],act3:[]};
let logEntries=[];

/* ACT SWITCH */
function switchAct(){
    currentAct=document.getElementById("actSelector").value;
}

/* TENSION */
function getThreshold(){
    if(weCount<5) return 4;
    if(weCount<10) return 3;
    return 2;
}

function increaseTension(){
    tension++;
    tensionSinceLastWE++;
    document.getElementById("tensionValue").textContent=tension;

    let box=document.createElement("div");
    box.className="tensionBox";
    document.getElementById("tensionRow").appendChild(box);

    if(tensionSinceLastWE>=getThreshold()){
        tensionSinceLastWE=0;
        weCount++;
        drawWorldEvent();
    }
}

function decreaseTension(){
    if(tension<=0) return;
    tension--;
    document.getElementById("tensionValue").textContent=tension;
    let row=document.getElementById("tensionRow");
    if(row.lastChild) row.removeChild(row.lastChild);
}

function resetTension(){
  tension = 0;
  tensionSinceLastWE = 0;
  weCount = 0;

  document.getElementById("tensionRow").innerHTML = "";
  document.getElementById("weGrid").innerHTML = "";

  document.getElementById("tensionValue").textContent = 0;
  document.getElementById("weCount").textContent = 0;
}

/* PRESENCE */
function changePresence(v){
    presence+=v;
    if(presence<0) presence=0;
    updatePresence();
}

function updatePresence(){
    document.getElementById("presenceValue").textContent=presence;
    let fill=document.getElementById("presenceFill");
    let tier=document.getElementById("presenceTier");

    let percent=Math.min((presence/15)*100,100);
    fill.style.width=percent+"%";

    if(presence<=2){ fill.style.background="#1abc9c"; tier.textContent="Dormant (0–2)"; }
    else if(presence<=4){ fill.style.background="#2ecc71"; tier.textContent="Stirring (3–4)"; }
    else if(presence<=6){ fill.style.background="#f1c40f"; tier.textContent="Unstable (5–6)"; }
    else if(presence<=8){ fill.style.background="#e67e22"; tier.textContent="Hostile (7–8)"; }
    else if(presence<=10){ fill.style.background="#e74c3c"; tier.textContent="Critical (9–10)"; }
    else{ fill.style.background="#8b0000"; tier.textContent="Cataclysm (11+)"; }
}

/* EVENT DRAW */
function drawWorldEvent(){
    let pool=worldEventPools[currentAct];
    if(!pool||pool.length===0) return;

    let used=usedEventsByAct[currentAct];
    if(used.length>=pool.length){
        usedEventsByAct[currentAct]=[];
        used=[];
    }

    let available=pool.filter((_,i)=>!used.includes(i));
    let event=available[Math.floor(Math.random()*available.length)];
    used.push(pool.indexOf(event));

    openEventModal(event);
}

/* EVENT MODAL WITH LOGGING */
function openEventModal(event){

    document.getElementById("eventTitle").textContent = event.title;
    document.getElementById("eventText").textContent = event.text;

    let container = document.getElementById("eventOptions");
    container.innerHTML = "";

    event.options.forEach(o => {

        let btn = document.createElement("button");
        btn.textContent = o.label + " [" + o.tag + "]";

        btn.onclick = () => {

            addLog(event.title + " → " + o.label + " (" + o.tag + ")");

            container.innerHTML = `
                <div style="margin-top:15px;font-size:1.1em;">
                    <strong>${o.label}</strong>
                </div>

                <div style="margin-top:10px;font-style:italic;opacity:0.9;">
                    ${o.effect || "The world shifts..."}
                </div>

                <button id="continueBtn" style="margin-top:20px;">
                    Continue
                </button>
            `;

            document.getElementById("continueBtn").onclick = () => {
                document.getElementById("eventModal").style.display = "none";
            };

        };

        container.appendChild(btn);
    });

    document.getElementById("eventModal").style.display = "flex";
}

/* LOG SYSTEM */
function addLog(entry){
    let time = new Date().toLocaleTimeString();
    logEntries.unshift("[" + time + "] " + entry);
    renderLog();
}

function renderLog(){
    let container = document.getElementById("logContainer");
    container.innerHTML = "";

    logEntries.forEach(e=>{
        let div=document.createElement("div");
        div.textContent=e;
        container.appendChild(div);
    });
}

function clearLog(){
    logEntries=[];
    renderLog();
}

/* SAVE */
function saveCampaign(){
    let slot=document.getElementById("saveSlot").value;
    localStorage.setItem(slot,JSON.stringify({tension,presence,currentAct,logEntries}));
}

function loadCampaign(){
    let slot=document.getElementById("saveSlot").value;
    let data=localStorage.getItem(slot);
    if(!data) return;
    let state=JSON.parse(data);
    tension=state.tension||0;
    presence=state.presence||0;
    currentAct=state.currentAct||"act1";
    logEntries=state.logEntries||[];
    document.getElementById("actSelector").value=currentAct;
    document.getElementById("tensionValue").textContent=tension;
    updatePresence();
    renderLog();
}

updatePresence();

</script>
</body>
</html>
