<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>World Fracture</title>

<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
    margin:0;
    font-family:'Cinzel', serif;
    letter-spacing:0.5px;
    background:#111;
    color:#e6d3a3;
    text-align:center;
}

.section{
    margin:20px;
    padding:15px;
    background:#1a1a1a;
    border-radius:10px;
}

button, select, input{
    margin:5px;
    padding:8px 12px;
    border:none;
    border-radius:6px;
    background:#3a2f1b;
    color:#e6d3a3;
    cursor:pointer;
}

#tensionRow{
    display:flex;
    flex-wrap:wrap;
    gap:5px;
    justify-content:center;
}

.tensionBox{
    width:20px;
    height:20px;
    border-radius:4px;
}

#weGrid{
    display:grid;
    grid-template-columns:repeat(5,1fr);
    gap:6px;
}

.weSlot{
    height:35px;
    background:#222;
    border-radius:4px;
}

#presenceBar{
    height:12px;
    background:#333;
    border-radius:5px;
    overflow:hidden;
}

#presenceFill{
    height:100%;
    width:0%;
    transition:.3s;
}

#logContainer{
    max-height:200px;
    overflow-y:auto;
    background:#111;
    padding:10px;
    border-radius:6px;
    text-align:left;
    font-size:0.9em;
}

.modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.9);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:1000;
}

.modal-content{
    background:#1a1a1a;
    padding:25px;
    border-radius:10px;
    width:90%;
    max-width:500px;
    text-align:left;
}

.optionBtn{
    display:block;
    width:100%;
    margin:8px 0;
    text-align:left;
}

#effectBox{
    margin-top:15px;
    padding:10px;
    background:#222;
    border-radius:6px;
    display:none;
}

#confirmBtn{
    margin-top:10px;
    display:none;
}
</style>
</head>
<body>

<h1>WORLD FRACTURE</h1>

<div class="section">
<select id="saveSlot"></select>
<input type="text" id="campaignNameInput" placeholder="Campaign Name">
<button onclick="saveCampaign()">Save</button>
<button onclick="loadCampaign()">Load</button>
</div>

<div class="section">
<h2>Current Act</h2>
<select id="actSelector" onchange="changeAct()">
<option value="act1">Act I</option>
<option value="act2">Act II</option>
<option value="act3">Act III</option>
</select>
</div>

<div class="section">
<h2>Tension: <span id="tensionValue">0</span></h2>
<div id="tensionRow"></div>
<button onclick="increaseTension()">+Tension</button>
</div>

<div class="section">
<h2>World Events: <span id="weCount">0</span></h2>
<div id="weGrid"></div>
</div>

<div class="section">
<h2>Presence: <span id="presenceValue">0</span></h2>
<div id="presenceBar"><div id="presenceFill"></div></div>
<button onclick="changePresence(1)">+1</button>
<button onclick="changePresence(-1)">-1</button>
</div>

<div class="section">
<h2>Cave Log</h2>
<div id="logContainer"></div>
</div>

<div class="modal" id="eventModal">
<div class="modal-content">
<h2 id="eventTitle"></h2>
<p id="eventText"></p>
<div id="eventOptions"></div>
<div id="effectBox"></div>
<button id="confirmBtn">Confirm Resolution</button>
</div>
</div>

<script>
let tension=0,weCount=0,tensionSinceLastWE=0,presence=0;
let logEntries=[];
let usedEventsByAct={act1:[],act2:[],act3:[]};
let currentAct="act1";
let selectedEventTitle="",selectedTag="";

const tensionRow=document.getElementById("tensionRow");
const weGrid=document.getElementById("weGrid");

const worldEventPools={
act1:[ /* YOUR 45 ACT I EVENTS STAY HERE — unchanged */ ],
act2:[],
act3:[]
};

/* -------- ACT SWITCH -------- */

function changeAct(){
currentAct=document.getElementById("actSelector").value;
addLog("Switched to "+currentAct.toUpperCase()+".");
}

/* -------- DRAW -------- */

function drawWorldEvent(){
let pool=worldEventPools[currentAct];
if(!pool || pool.length===0){
addLog("No World Events in this Act yet.");
return;
}

let used=usedEventsByAct[currentAct];
if(used.length===pool.length){
usedEventsByAct[currentAct]=[];
used=[];
}

let available=pool.filter((_,i)=>!used.includes(i));
let index=Math.floor(Math.random()*available.length);
let eventIndex=pool.indexOf(available[index]);
used.push(eventIndex);

openEventModal(pool[eventIndex]);
}

/* -------- MODAL -------- */

function openEventModal(event){
selectedEventTitle=event.title;
document.getElementById("eventTitle").innerText=event.title;
document.getElementById("eventText").innerText=event.text;

let container=document.getElementById("eventOptions");
container.innerHTML="";
document.getElementById("effectBox").style.display="none";
document.getElementById("confirmBtn").style.display="none";

event.options.forEach(o=>{
let btn=document.createElement("button");
btn.className="optionBtn";
btn.innerText=o.label+" ["+o.tag+"]";
btn.onclick=()=>showEffect(o.tag,o.effect);
container.appendChild(btn);
});

document.getElementById("eventModal").style.display="flex";
}

function showEffect(tag,effect){
selectedTag=tag;
let box=document.getElementById("effectBox");
box.innerText=effect;
box.style.display="block";
let confirmBtn=document.getElementById("confirmBtn");
confirmBtn.style.display="block";
confirmBtn.onclick=confirmResolution;
}

function confirmResolution(){
addLog(selectedEventTitle+" — "+selectedTag);
document.getElementById("eventModal").style.display="none";
}

/* -------- TENSION -------- */

function increaseTension(){
tension++;
tensionSinceLastWE++;

let box=document.createElement("div");
box.className="tensionBox";
box.style.background="#e74c3c";
tensionRow.appendChild(box);

if(tensionSinceLastWE>=4){
let slot=document.createElement("div");
slot.className="weSlot";
weGrid.appendChild(slot);
weCount++;
tensionSinceLastWE=0;
drawWorldEvent();
}
}

/* -------- PRESENCE -------- */

function changePresence(v){
presence+=v;
if(presence<0)presence=0;
document.getElementById("presenceValue").innerText=presence;
}

/* -------- LOG -------- */

function addLog(msg){
let time=new Date().toLocaleTimeString();
logEntries.unshift("["+time+"] "+msg);
renderLog();
}

function renderLog(){
let c=document.getElementById("logContainer");
c.innerHTML="";
logEntries.forEach(e=>{
let d=document.createElement("div");
d.textContent=e;
c.appendChild(d);
});
}

/* -------- SAVE / LOAD -------- */

function saveCampaign(){
localStorage.setItem("campaignData",JSON.stringify({
tension,weCount,tensionSinceLastWE,presence,logEntries,usedEventsByAct,currentAct
}));
alert("Saved.");
}

function loadCampaign(){
let data=localStorage.getItem("campaignData");
if(!data)return;
let state=JSON.parse(data);
tension=state.tension;
weCount=state.weCount;
tensionSinceLastWE=state.tensionSinceLastWE;
presence=state.presence;
logEntries=state.logEntries||[];
usedEventsByAct=state.usedEventsByAct||{act1:[],act2:[],act3:[]};
currentAct=state.currentAct||"act1";
document.getElementById("actSelector").value=currentAct;
renderLog();
}

renderLog();
</script>
</body>
</html>
