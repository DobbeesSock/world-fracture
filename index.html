<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>World Fracture</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
    margin:0;
    font-family:'Cinzel', serif;
    background:#111;
    color:#e6d3a3;
    text-align:center;
}

.section{
    margin:20px;
    padding:15px;
    background:#1a1a1a;
    border-radius:10px;
}

button, select{
    margin:5px;
    padding:8px 12px;
    border:none;
    border-radius:6px;
    background:#3a2f1b;
    color:#e6d3a3;
    cursor:pointer;
}

#tensionRow{
    display:flex;
    flex-wrap:wrap;
    gap:5px;
    justify-content:center;
}

.tensionBox{
    width:20px;
    height:20px;
    border-radius:4px;
    background:#e74c3c;
}

#weGrid{
    display:grid;
    grid-template-columns:repeat(5,1fr);
    gap:6px;
}

.weSlot{
    height:35px;
    border-radius:4px;
    background:#e74c3c;
}

#presenceBar{
    height:16px;
    width:100%;
    background:#333;
    border-radius:8px;
    overflow:hidden;
}

#presenceFill{
    height:100%;
    width:0%;
    transition:width .3s ease, background .3s ease;
}

.modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.9);
    display:none;
    align-items:center;
    justify-content:center;
}

.modal-content{
    background:#1a1a1a;
    padding:25px;
    border-radius:10px;
    width:90%;
    max-width:500px;
    text-align:left;
}
</style>
</head>
<body>

<h1>WORLD FRACTURE</h1>

<div class="section">
<h2>Current Act</h2>
<select id="actSelector" onchange="switchAct()">
<option value="act1">Act I</option>
<option value="act2">Act II</option>
<option value="act3">Act III</option>
</select>
</div>

<div class="section">
<h2>Tension: <span id="tensionValue">0</span></h2>
<div id="tensionRow"></div>
<button onclick="increaseTension()">+Tension</button>
<button onclick="decreaseTension()">-Tension</button>
<button onclick="resetTension()">Reset</button>
</div>

<div class="section">
<h2>World Events: <span id="weCount">0</span></h2>
<div id="weGrid"></div>
</div>

<div class="section">
<h2>Presence: <span id="presenceValue">0</span></h2>
<div id="presenceBar">
<div id="presenceFill"></div>
</div>
<div>Tier: <span id="presenceTier">Dormant (0–2)</span></div>
<button onclick="changePresence(1)">+1</button>
<button onclick="changePresence(-1)">-1</button>
<button onclick="resetPresence()">Reset</button>
</div>

<div class="modal" id="eventModal">
<div class="modal-content">
<h2 id="eventTitle"></h2>
<p id="eventText"></p>
<div id="eventOptions"></div>
</div>
</div>

<script>

/* ================= STATE ================= */

let tension=0;
let tensionSinceLastWE=0;
let weCount=0;
let presence=0;
let currentAct="act1";
let usedEventsByAct={act1:[],act2:[],act3:[]};

/* ================= EVENTS ================= */

const worldEventPools={
act1:[
{
title:"The World Anchor ⚖️",
text:"A titanic spike of stone plunges endlessly downward.",
options:[
{label:"Reinforce",tag:"Order",effect:"All factions gain 1 Relic."},
{label:"Damage",tag:"Profit",effect:"Spawn a World Boss."}
]
}
],
act2:[
{
title:"Act II Test Event",
text:"This is an Act II test event.",
options:[
{label:"Test",tag:"Test",effect:"Nothing happens."}
]
}
],
act3:[]
};

/* ================= ACT SWITCH ================= */

function switchAct(){
let newAct=document.getElementById("actSelector").value;
if(newAct===currentAct) return;

if(!confirm("Switching Acts resets Tension. Continue?")){
document.getElementById("actSelector").value=currentAct;
return;
}

currentAct=newAct;
resetTension();
}

/* ================= TENSION ================= */

function getThreshold(){
if(weCount<5) return 4;
if(weCount<10) return 3;
return 2;
}

function increaseTension(){
tension++;
tensionSinceLastWE++;

document.getElementById("tensionValue").textContent=tension;

let box=document.createElement("div");
box.className="tensionBox";
document.getElementById("tensionRow").appendChild(box);

if(tensionSinceLastWE>=getThreshold()){
tensionSinceLastWE=0;

let slot=document.createElement("div");
slot.className="weSlot";
document.getElementById("weGrid").appendChild(slot);

weCount++;
document.getElementById("weCount").textContent=weCount;

drawWorldEvent();
}
}

function decreaseTension(){
if(tension<=0) return;
tension--;
document.getElementById("tensionValue").textContent=tension;
let row=document.getElementById("tensionRow");
if(row.lastChild) row.removeChild(row.lastChild);
}

function resetTension(){
tension=0;
weCount=0;
tensionSinceLastWE=0;
document.getElementById("tensionRow").innerHTML="";
document.getElementById("weGrid").innerHTML="";
document.getElementById("tensionValue").textContent=0;
document.getElementById("weCount").textContent=0;
}

/* ================= PRESENCE ================= */

function changePresence(v){
presence+=v;
if(presence<0) presence=0;
updatePresence();
}

function resetPresence(){
presence=0;
updatePresence();
}

function updatePresence(){
document.getElementById("presenceValue").textContent=presence;
let fill=document.getElementById("presenceFill");
let tier=document.getElementById("presenceTier");

let percent=Math.min((presence/15)*100,100);
fill.style.width=percent+"%";

if(presence<=2){ fill.style.background="#1abc9c"; tier.textContent="Dormant (0–2)"; }
else if(presence<=4){ fill.style.background="#2ecc71"; tier.textContent="Stirring (3–4)"; }
else if(presence<=6){ fill.style.background="#f1c40f"; tier.textContent="Unstable (5–6)"; }
else if(presence<=8){ fill.style.background="#e67e22"; tier.textContent="Hostile (7–8)"; }
else if(presence<=10){ fill.style.background="#e74c3c"; tier.textContent="Critical (9–10)"; }
else{ fill.style.background="#8b0000"; tier.textContent="Cataclysm (11+)"; }
}

/* ================= EVENT DRAW ================= */

function drawWorldEvent(){

let pool=worldEventPools[currentAct];
let used=usedEventsByAct[currentAct];

if(pool.length===0) return;

if(used.length===pool.length){
usedEventsByAct[currentAct]=[];
used=[];
}

let available=pool.filter((_,i)=>!used.includes(i));
let randomIndex=Math.floor(Math.random()*available.length);
let eventIndex=pool.indexOf(available[randomIndex]);

used.push(eventIndex);

openEventModal(pool[eventIndex]);
}

function openEventModal(event){
document.getElementById("eventTitle").textContent=event.title;
document.getElementById("eventText").textContent=event.text;

let container=document.getElementById("eventOptions");
container.innerHTML="";

event.options.forEach(o=>{
let btn=document.createElement("button");
btn.textContent=o.label+" ["+o.tag+"]";
btn.onclick=()=>document.getElementById("eventModal").style.display="none";
container.appendChild(btn);
});

document.getElementById("eventModal").style.display="flex";
}

/* INIT */
updatePresence();

</script>
</body>
</html>
