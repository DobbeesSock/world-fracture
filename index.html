<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>World Fracture</title>

<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{
    margin:0;
    font-family:'Cinzel', serif;
    letter-spacing:0.5px;
    background:#111;
    color:#e6d3a3;
    text-align:center;
    transition: background 1s ease, filter 1s ease;
}

.section{
    margin:20px;
    padding:15px;
    background:#1a1a1a;
    border-radius:10px;
}

button, select, input{
    margin:5px;
    padding:8px 12px;
    border:none;
    border-radius:6px;
    background:#3a2f1b;
    color:#e6d3a3;
    cursor:pointer;
}

#tensionRow{
    display:flex;
    flex-wrap:wrap;
    gap:5px;
    justify-content:center;
}

.tensionBox{
    width:20px;
    height:20px;
    border-radius:4px;
}

#weGrid{
    display:grid;
    grid-template-columns:repeat(5,1fr);
    gap:6px;
}

.weSlot{
    height:35px;
    background:#222;
    border-radius:4px;
    transition:0.3s;
}

.wePulse{ animation:pulse 0.6s ease; }
.weHigh{ box-shadow:0 0 10px rgba(255,0,0,0.7); }

@keyframes pulse{
    0%{transform:scale(1);}
    50%{transform:scale(1.15);}
    100%{transform:scale(1);}
}

#presenceBar{
    height:12px;
    background:#333;
    border-radius:5px;
    overflow:hidden;
}

#presenceFill{
    height:100%;
    width:0%;
    transition:.3s;
}

#logContainer{
    max-height:200px;
    overflow-y:auto;
    background:#111;
    padding:10px;
    border-radius:6px;
    text-align:left;
    font-size:0.9em;
}

.modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.9);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:1000;
}

.modal-content{
    background:#1a1a1a;
    padding:25px;
    border-radius:10px;
    width:90%;
    max-width:500px;
    text-align:left;
}

.optionBtn{
    display:block;
    width:100%;
    margin:8px 0;
    text-align:left;
}

#effectBox{
    margin-top:15px;
    padding:10px;
    background:#222;
    border-radius:6px;
    display:none;
}

#confirmBtn{
    margin-top:10px;
    display:none;
}
</style>
</head>
<body>

<h1>WORLD FRACTURE</h1>

<div class="section">
<select id="saveSlot"></select>
<input type="text" id="campaignNameInput" placeholder="Campaign Name">
<button onclick="saveCampaign()">Save</button>
<button onclick="loadCampaign()">Load</button>
<button onclick="newCampaign()">New Campaign</button>
<button onclick="exportCampaign()">Export</button>
<input type="file" id="importFile" style="display:none" onchange="importCampaign(event)">
<button onclick="document.getElementById('importFile').click()">Import</button>
</div>

<div class="section">
<h2>Tension: <span id="tensionValue">0</span></h2>
<div id="tensionRow"></div>
<button onclick="increaseTension()">+Tension</button>
<button onclick="decreaseTension()">-Tension</button>
<button onclick="resetTension()">Reset</button>
</div>

<div class="section">
<h2>World Events: <span id="weCount">0</span></h2>
<div id="weGrid"></div>
</div>

<div class="section">
<h2>Presence: <span id="presenceValue">0</span></h2>
<div id="presenceBar"><div id="presenceFill"></div></div>
<div>Tier: <span id="presenceTier">0–2</span></div>
<button onclick="changePresence(1)">+1</button>
<button onclick="changePresence(-1)">-1</button>
<button onclick="resetPresence()">Reset</button>
</div>

<div class="section">
<h2>Cave Log</h2>
<div id="logContainer"></div>
<button onclick="clearLog()">Clear Log</button>
</div>

<div class="modal" id="eventModal">
<div class="modal-content">
<h2 id="eventTitle"></h2>
<p id="eventText"></p>
<div id="eventOptions"></div>
<div id="effectBox"></div>
<button id="confirmBtn">Confirm Resolution</button>
</div>
</div>

<script>
let tension=0,weCount=0,tensionSinceLastWE=0,presence=0;
let logEntries=[],usedEvents=[];
let selectedEventTitle="",selectedTag="";
const tensionRow=document.getElementById("tensionRow");
const weGrid=document.getElementById("weGrid");

/* ================= ACT I EVENTS ================= */

const worldEventPools={
act1:[

{
title:"The World Anchor ⚖️",
text:"A titanic spike of stone plunges endlessly downward. Runes from every culture spiral around it. This is holding something still.",
options:[
{label:"Reinforce the Anchor",tag:"Order",effect:"All factions gain +1 stability. Endgame threats grow stronger."},
{label:"Damage the Anchor",tag:"Profit",effect:"Gain 3 Chest Cards (shared among factions). Begin an unavoidable apocalypse track."},
{label:"Remove the Anchor",tag:"Freedom",effect:"Immediately resolve one endgame threat. Replace it with something unknown."}
]
},

{
title:"The Shared Grave ⚖️",
text:"Every faction’s banners hang here—old, tattered, impossible. This place remembers wars that haven’t happened yet.",
options:[
{label:"Honor the Dead",tag:"Reverence",effect:"All factions gain +1 morale permanently. Resurrection becomes more expensive."},
{label:"Loot the Graves",tag:"Desecration",effect:"Each faction gains 1 Chest Card. All deaths now empower enemies."},
{label:"Burn the Banners",tag:"Defiance",effect:"Cancel one faction-wide penalty. Start all future conflicts at higher intensity."}
]
},

{
title:"The Silent Contract ⚖️",
text:"A stone table. No writing. Just space for signatures.",
options:[
{label:"Sign Together",tag:"Alliance",effect:"Once per campaign, factions may ignore hostility."},
{label:"Refuse",tag:"Independence",effect:"Gain 2 Legendary Potions per faction. Diplomacy is permanently weakened."},
{label:"One Faction Signs Alone",tag:"Betrayal",effect:"That faction gains massive bonuses. Everyone else gains a reason to hate them."}
]
},

{
title:"The Hunger Beneath Empires ⚖️",
text:"The ground pulses across the entire map. This thing feeds on excess.",
options:[
{label:"Feed It Regularly",tag:"Appeasement",effect:"Sacrifice resources each cycle. Prevents catastrophic events."},
{label:"Starve It",tag:"Greed",effect:"Gain a surge of resources now. Something will wake later."},
{label:"Try to Kill It",tag:"Reckoning",effect:"Roll once for the entire table. Success grants relics. Failure triggers campaign-ending escalation."}
]
},

{
title:"The Last Descent ⚖️",
text:"It offers no choices. Only a mirror. Everyone sees what they’ve become.",
options:[
{label:"Accept Judgment",tag:"Judgment",effect:"Convert all unused boons into power. Convert ignored consequences into enemies. Lock campaign into final arc."}
]
},

{
title:"The Forgotten Contract",
text:"The stone remembers promises—even unspoken ones.",
options:[
{label:"Bind Yourselves",tag:"Oath",effect:"Once per campaign all factions ignore hostility. Presence cannot be reduced for 2 rounds."},
{label:"Refuse",tag:"Oath Broken",effect:"Each faction gains 2 Rare rewards. Table-wide distrust penalties apply."}
]
},

{
title:"The First Betrayal",
text:"The caves replay a moment that hasn’t happened yet. Everyone sees it differently.",
options:[
{label:"Name the Traitor",tag:"Fracture",effect:"Chosen faction gains massive power but becomes globally hostile."},
{label:"Deny the Vision",tag:"Denial",effect:"Cancel one future Table-Wide Cave. Presence increases by 1 permanently."}
]
},

{
title:"The Grave of Many Banners",
text:"Banners from every faction line the cavern walls. Some are already torn.",
options:[
{label:"Honor the Fallen",tag:"Remembrance",effect:"All factions gain +1 dragon coin. Graveyard resurrection now costs x3 unit cost."},
{label:"Loot the Dead",tag:"Profiteering",effect:"Each faction gains 1 Chest Card. Every unit death strengthens enemies."}
]
},

{
title:"The Golden Collapse",
text:"A city-sized vault buckles deep below.",
options:[
{
label:"Accept the Collapse",
tag:"Inflation",
effect:"All factions gain 14 Gold immediately. Markets destabilize; Exchange becomes 6:1. Presence +2."
}
]
},

{
title:"The Vault That Should Not Open",
text:"A single lock. Every key fits.",
options:[
{
label:"Open It Together",
tag:"Temptation",
effect:"Split 2 mythic rewards. Spawn a world boss."
},
{
label:"Seal It Forever",
tag:"Restraint",
effect:"Reduce Presence by 3. Lose access to mythic rewards."
}
]
},

{
title:"The Cave Remembers the Sun",
text:"The underworld recalls light—and wants it back.",
options:[
{
label:"Let the Light Return",
tag:"Reversal",
effect:"Triggers nighttime for this mission and the next. Caves gain +2 Stability. The world becomes harsher."
}
]
},

{
title:"The World Demands Tribute",
text:"Supply lines strain as the land itself exacts a cost. The table must choose collectively.",
options:[
{
label:"Pay the Land",
tag:"Submission",
effect:"Each faction pays 10 Food. No further effect."
},
{
label:"Refuse",
tag:"Defiance",
effect:"Spawn The Hunger of Many at the most contested POI. The creature immediately acts."
}
]
},

{
title:"Banners Draw Blood",
text:"So many standards fly that war can no longer be ignored. Each faction secretly chooses Yield or Stand Proud, then reveal.",
options:[
{
label:"Resolve the Banners",
tag:"Escalation",
effect:"Each faction that chose Yield loses 2 Keywords of their choice. Each faction that chose Stand Proud gains +10 Gold. For each Stand Proud faction, spawn a keyword-hunting creature targeting one of their keywords."
}
]
}
]
};

/* ================= ENGINE ================= */

function drawWorldEvent(){
let pool=worldEventPools.act1;
if(usedEvents.length===pool.length)usedEvents=[];
let available=pool.filter((_,i)=>!usedEvents.includes(i));
let index=Math.floor(Math.random()*available.length);
let eventIndex=pool.indexOf(available[index]);
usedEvents.push(eventIndex);
openEventModal(pool[eventIndex]);
}

function openEventModal(event){
selectedEventTitle=event.title;
document.getElementById("eventTitle").innerText=event.title;
document.getElementById("eventText").innerText=event.text;

let container=document.getElementById("eventOptions");
container.innerHTML="";
document.getElementById("effectBox").style.display="none";
document.getElementById("confirmBtn").style.display="none";

event.options.forEach(o=>{
let btn=document.createElement("button");
btn.className="optionBtn";
btn.innerText=o.label+" ["+o.tag+"]";
btn.onclick=()=>showEffect(o.tag,o.effect);
container.appendChild(btn);
});

document.getElementById("eventModal").style.display="flex";
}

function showEffect(tag,effect){
selectedTag=tag;
let box=document.getElementById("effectBox");
box.innerText=effect;
box.style.display="block";
let confirmBtn=document.getElementById("confirmBtn");
confirmBtn.style.display="block";
confirmBtn.onclick=confirmResolution;
}

function confirmResolution(){
addLog(selectedEventTitle+" — "+selectedTag);
document.getElementById("eventModal").style.display="none";
}

/* ========= Rest of engine unchanged ========= */

function addLog(msg){
let time=new Date().toLocaleTimeString();
logEntries.unshift("["+time+"] "+msg);
if(logEntries.length>100)logEntries.pop();
renderLog();
}

function renderLog(){
let c=document.getElementById("logContainer");
c.innerHTML="";
logEntries.forEach(e=>{
let d=document.createElement("div");
d.textContent=e;
c.appendChild(d);
});
}

function clearLog(){logEntries=[];renderLog();}

function getThreshold(){if(weCount<5)return 4;if(weCount<10)return 3;return 2;}
function getTensionColor(){
if(tension<10)return"#1abc9c";
if(tension<20)return"#2ecc71";
if(tension<30)return"#f1c40f";
if(tension<40)return"#e67e22";
if(tension<60)return"#e74c3c";
return"#8b0000";
}

function increaseTension(){
tension++;tensionSinceLastWE++;
addLog("Tension increased to "+tension+".");
let color=getTensionColor();
let box=document.createElement("div");
box.className="tensionBox";
box.style.background=color;
tensionRow.appendChild(box);

if(tensionSinceLastWE>=getThreshold()){
let slot=document.createElement("div");
slot.className="weSlot wePulse";
if(weCount>=10)slot.classList.add("weHigh");
slot.style.background=color;
weGrid.appendChild(slot);
weCount++;tensionSinceLastWE=0;
addLog("World Event triggered.");
drawWorldEvent();
}
}

function decreaseTension(){
if(tension<=0)return;
tension--;
tensionRow.removeChild(tensionRow.lastChild);
addLog("Tension decreased to "+tension+".");
}

function resetTension(){
tension=0;weCount=0;tensionSinceLastWE=0;
tensionRow.innerHTML="";weGrid.innerHTML="";
usedEvents=[];
addLog("Tension reset.");
}

</script>
</body>
</html>
