<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>World Fracture</title>

<style>
body{
    margin:0;
    font-family: serif;
    background:#111;
    color:#e6d3a3;
    text-align:center;
}
.section{
    margin:20px;
    padding:15px;
    background:#1a1a1a;
    border-radius:10px;
}
button, select{
    margin:5px;
    padding:8px 12px;
    border:none;
    border-radius:6px;
    background:#3a2f1b;
    color:#e6d3a3;
    cursor:pointer;
}
#presenceBar{
    height:16px;
    width:100%;
    background:#333;
    border-radius:8px;
    overflow:hidden;
}
#presenceFill{
    height:100%;
    width:0%;
    transition:width .3s ease, background .3s ease;
}
.modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.9);
    display:none;
    align-items:center;
    justify-content:center;
}
.modal-content{
    background:#1a1a1a;
    padding:25px;
    border-radius:10px;
    width:90%;
    max-width:500px;
}
</style>
</head>
<body>

<h1>WORLD FRACTURE</h1>

<!-- SAVE -->
<div class="section">
<button onclick="saveCampaign()">Save</button>
<button onclick="loadCampaign()">Load</button>
</div>

<!-- ACT -->
<div class="section">
<h2>Current Act</h2>
<select id="actSelector" onchange="switchAct()">
<option value="act1">Act I</option>
<option value="act2">Act II</option>
<option value="act3">Act III</option>
</select>
</div>

<!-- TENSION -->
<div class="section">
<h2>Tension: <span id="tensionValue">0</span></h2>
<button onclick="increaseTension()">+Tension</button>
<button onclick="drawWorldEvent()">Force Event</button>
</div>

<!-- PRESENCE -->
<div class="section">
<h2>Presence: <span id="presenceValue">0</span></h2>
<div id="presenceBar">
<div id="presenceFill"></div>
</div>
<button onclick="changePresence(1)">+1</button>
<button onclick="changePresence(-1)">-1</button>
</div>

<!-- MODAL -->
<div class="modal" id="eventModal">
<div class="modal-content">
<h2 id="eventTitle"></h2>
<p id="eventText"></p>
<div id="eventOptions"></div>
</div>
</div>

<!-- LOAD EVENTS -->
<script src="events.js"></script>

<script>

/* ================= STATE ================= */

let tension = 0;
let weCount = 0;
let presence = 0;
let currentAct = "act1";

let usedEventsByAct = {
  act1: [],
  act2: [],
  act3: []
};

/* ================= ACT ================= */

function switchAct(){
    currentAct = document.getElementById("actSelector").value;
}

/* ================= TENSION ================= */

function getThreshold(){
    if(weCount < 5) return 4;
    if(weCount < 10) return 3;
    return 2;
}

function increaseTension(){
    tension++;
    document.getElementById("tensionValue").textContent = tension;

    if(tension >= getThreshold()){
        tension = 0;
        weCount++;
        document.getElementById("tensionValue").textContent = tension;
        drawWorldEvent();
    }
}

/* ================= PRESENCE ================= */

function changePresence(v){
    presence += v;
    if(presence < 0) presence = 0;

    document.getElementById("presenceValue").textContent = presence;

    let percent = Math.min((presence/15)*100,100);
    let fill = document.getElementById("presenceFill");
    fill.style.width = percent + "%";

    if(presence <= 2) fill.style.background = "#1abc9c";
    else if(presence <= 4) fill.style.background = "#2ecc71";
    else if(presence <= 6) fill.style.background = "#f1c40f";
    else if(presence <= 8) fill.style.background = "#e67e22";
    else if(presence <= 10) fill.style.background = "#e74c3c";
    else fill.style.background = "#8b0000";
}

/* ================= EVENT DRAW ================= */

function drawWorldEvent(){

    if(typeof worldEventPools === "undefined") return;

    let pool = worldEventPools[currentAct];
    if(!pool || pool.length === 0) return;

    let used = usedEventsByAct[currentAct];

    if(used.length >= pool.length){
        usedEventsByAct[currentAct] = [];
        used = [];
    }

    let available = pool.filter((_,i)=>!used.includes(i));
    let randomIndex = Math.floor(Math.random() * available.length);
    let event = available[randomIndex];

    let realIndex = pool.indexOf(event);
    usedEventsByAct[currentAct].push(realIndex);

    openEventModal(event);
}

function openEventModal(event){

    document.getElementById("eventTitle").textContent = event.title;
    document.getElementById("eventText").textContent = event.text;

    let container = document.getElementById("eventOptions");
    container.innerHTML = "";

    event.options.forEach(o=>{
        let btn = document.createElement("button");
        btn.textContent = o.label + " [" + o.tag + "]";
        btn.onclick = ()=>document.getElementById("eventModal").style.display="none";
        container.appendChild(btn);
    });

    document.getElementById("eventModal").style.display="flex";
}

/* ================= SAVE / LOAD ================= */

function saveCampaign(){
    localStorage.setItem("wfSave", JSON.stringify({
        tension,
        weCount,
        presence,
        currentAct,
        usedEventsByAct
    }));
}

function loadCampaign(){
    let data = localStorage.getItem("wfSave");
    if(!data) return;

    let state = JSON.parse(data);

    tension = state.tension || 0;
    weCount = state.weCount || 0;
    presence = state.presence || 0;
    currentAct = state.currentAct || "act1";
    usedEventsByAct = state.usedEventsByAct || usedEventsByAct;

    document.getElementById("actSelector").value = currentAct;
    document.getElementById("tensionValue").textContent = tension;
    document.getElementById("presenceValue").textContent = presence;
    changePresence(0);
}

</script>
</body>
</html>
