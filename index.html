<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>World Fracture</title>

<link rel="manifest" href="manifest.json">

<style>
body{
    margin:0;
    font-family:Segoe UI, sans-serif;
    background:#111;
    color:#e6d3a3;
    text-align:center;
}

.section{
    margin:20px;
    padding:15px;
    background:#1a1a1a;
    border-radius:10px;
}

button, select, input{
    margin:5px;
    padding:8px 12px;
    border:none;
    border-radius:6px;
    background:#3a2f1b;
    color:#e6d3a3;
}

#tensionRow{
    display:flex;
    flex-wrap:wrap;
    gap:5px;
    justify-content:center;
}

.tensionBox{
    width:20px;
    height:20px;
    border-radius:4px;
}

#weGrid{
    display:grid;
    grid-template-columns:repeat(5,1fr);
    gap:6px;
}

.weSlot{
    height:35px;
    background:#222;
    border-radius:4px;
}

#presenceBar{
    height:12px;
    background:#333;
    border-radius:5px;
    overflow:hidden;
}

#presenceFill{
    height:100%;
    width:0%;
    transition:.3s;
}

#logContainer{
    max-height:200px;
    overflow-y:auto;
    background:#111;
    padding:10px;
    border-radius:6px;
    text-align:left;
    font-size:0.9em;
}

/* Modal */
.modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.7);
    display:none;
    align-items:center;
    justify-content:center;
}

.modal-content{
    background:#1a1a1a;
    padding:20px;
    border-radius:10px;
    width:90%;
    max-width:400px;
}
</style>
</head>
<body>

<h1>WORLD FRACTURE</h1>

<div class="section">
<select id="saveSlot"></select>
<input type="text" id="campaignNameInput" placeholder="Campaign Name">
<button onclick="saveCampaign()">Save</button>
<button onclick="loadCampaign()">Load</button>
<button onclick="newCampaign()">New Campaign</button>
<button onclick="exportCampaign()">Export</button>
<input type="file" id="importFile" style="display:none" onchange="importCampaign(event)">
<button onclick="document.getElementById('importFile').click()">Import</button>
</div>

<div class="section">
<h2>Tension: <span id="tensionValue">0</span></h2>
<div id="tensionRow"></div>
<button onclick="increaseTension()">+Tension</button>
<button onclick="decreaseTension()">-Tension</button>
<button onclick="resetTension()">Reset</button>
</div>

<div class="section">
<h2>World Events: <span id="weCount">0</span></h2>
<div id="weGrid"></div>
</div>

<div class="section">
<h2>Presence: <span id="presenceValue">0</span></h2>
<div id="presenceBar"><div id="presenceFill"></div></div>
<div>Tier: <span id="presenceTier">0–2</span></div>
<button onclick="changePresence(1)">+1</button>
<button onclick="changePresence(-1)">-1</button>
<button onclick="resetPresence()">Reset</button>
</div>

<div class="section">
<h2>Cave Log</h2>
<div id="logContainer"></div>
<button onclick="clearLog()">Clear Log</button>
</div>

<div class="modal" id="confirmModal">
<div class="modal-content">
<p>Start a new campaign in this slot? This will erase existing data.</p>
<button onclick="confirmNewCampaign()">Confirm</button>
<button onclick="closeModal()">Cancel</button>
</div>
</div>

<script>
let tension=0;
let weCount=0;
let tensionSinceLastWE=0;
let presence=0;
let logEntries=[];
let campaignNames={
    slot1:"Campaign Slot 1",
    slot2:"Campaign Slot 2",
    slot3:"Campaign Slot 3"
};

const slots=["slot1","slot2","slot3"];
const tensionRow=document.getElementById("tensionRow");
const weGrid=document.getElementById("weGrid");
const saveSlotSelect=document.getElementById("saveSlot");

/* ---------- INIT ---------- */
function initSlots(){
    saveSlotSelect.innerHTML="";
    slots.forEach(slot=>{
        let option=document.createElement("option");
        option.value=slot;
        option.textContent=campaignNames[slot];
        saveSlotSelect.appendChild(option);
    });
}

initSlots();

/* ---------- RULES ---------- */
function getThreshold(){
 if(weCount<5)return 4;
 if(weCount<10)return 3;
 return 2;
}

function getTensionColor(){
 if(tension<10)return "#1abc9c";
 if(tension<20)return "#2ecc71";
 if(tension<30)return "#f1c40f";
 if(tension<40)return "#e67e22";
 if(tension<60)return "#e74c3c";
 return "#8b0000";
}

function getPresenceTier(){
 if(presence>=13)return "13–15+";
 if(presence>=11)return "11–12";
 if(presence>=9)return "9–10";
 if(presence>=7)return "7–8";
 if(presence>=5)return "5–6";
 if(presence>=3)return "3–4";
 return "0–2";
}

/* ---------- LOG ---------- */
function addLog(msg){
 let time=new Date().toLocaleTimeString();
 logEntries.unshift("["+time+"] "+msg);
 if(logEntries.length>100)logEntries.pop();
 renderLog();
}

function renderLog(){
 let container=document.getElementById("logContainer");
 container.innerHTML="";
 logEntries.forEach(e=>{
   let div=document.createElement("div");
   div.textContent=e;
   container.appendChild(div);
 });
}

function clearLog(){
 logEntries=[];
 renderLog();
}

/* ---------- TENSION ---------- */
function increaseTension(){
 tension++;
 tensionSinceLastWE++;
 addLog("Tension increased to "+tension+".");

 let color=getTensionColor();
 let box=document.createElement("div");
 box.className="tensionBox";
 box.style.background=color;
 tensionRow.appendChild(box);

 if(tensionSinceLastWE>=getThreshold()){
   let slot=document.createElement("div");
   slot.className="weSlot";
   slot.style.background=color;
   weGrid.appendChild(slot);
   weCount++;
   tensionSinceLastWE=0;
   addLog("World Event triggered.");
 }

 updateUI();
}

function decreaseTension(){
 if(tension<=0)return;
 tension--;
 tensionRow.removeChild(tensionRow.lastChild);
 addLog("Tension decreased to "+tension+".");
 updateUI();
}

function resetTension(){
 tension=0; weCount=0; tensionSinceLastWE=0;
 tensionRow.innerHTML="";
 weGrid.innerHTML="";
 addLog("Tension reset.");
 updateUI();
}

/* ---------- PRESENCE ---------- */
function changePresence(v){
 presence+=v;
 if(presence<0)presence=0;
 addLog("Presence adjusted to "+presence+".");
 updateUI();
}

function resetPresence(){
 presence=0;
 addLog("Presence reset.");
 updateUI();
}

/* ---------- UI ---------- */
function updateUI(){
 document.getElementById("tensionValue").innerText=tension;
 document.getElementById("weCount").innerText=weCount;
 document.getElementById("presenceValue").innerText=presence;
 document.getElementById("presenceTier").innerText=getPresenceTier();

 let fill=document.getElementById("presenceFill");
 fill.style.width=Math.min(presence*6,100)+"%";
 fill.style.background=presence>=13?"darkred":"gold";
}

/* ---------- SAVE SYSTEM ---------- */
function saveCampaign(){
 let slot=saveSlotSelect.value;
 let name=document.getElementById("campaignNameInput").value;
 if(name)campaignNames[slot]=name;

 localStorage.setItem("campaignNames",JSON.stringify(campaignNames));

 localStorage.setItem(slot,JSON.stringify({
   tension,weCount,tensionSinceLastWE,presence,logEntries
 }));

 initSlots();
 alert("Saved.");
}

function loadCampaign(){
 let slot=saveSlotSelect.value;
 let data=localStorage.getItem(slot);
 if(!data){alert("No save found.");return;}

 let state=JSON.parse(data);
 tension=state.tension;
 weCount=state.weCount;
 tensionSinceLastWE=state.tensionSinceLastWE;
 presence=state.presence;
 logEntries=state.logEntries||[];

 tensionRow.innerHTML="";
 weGrid.innerHTML="";
 for(let i=0;i<tension;i++){
   let box=document.createElement("div");
   box.className="tensionBox";
   box.style.background=getTensionColor();
   tensionRow.appendChild(box);
 }
 for(let i=0;i<weCount;i++){
   let slot=document.createElement("div");
   slot.className="weSlot";
   slot.style.background=getTensionColor();
   weGrid.appendChild(slot);
 }

 renderLog();
 updateUI();
}

/* ---------- NEW CAMPAIGN ---------- */
function newCampaign(){
 document.getElementById("confirmModal").style.display="flex";
}

function confirmNewCampaign(){
 let slot=saveSlotSelect.value;
 localStorage.removeItem(slot);
 tension=0;weCount=0;tensionSinceLastWE=0;presence=0;logEntries=[];
 tensionRow.innerHTML="";
 weGrid.innerHTML="";
 renderLog();
 updateUI();
 closeModal();
}

function closeModal(){
 document.getElementById("confirmModal").style.display="none";
}

/* ---------- EXPORT ---------- */
function exportCampaign(){
 let slot=saveSlotSelect.value;
 let data=localStorage.getItem(slot);
 if(!data){alert("Nothing to export.");return;}

 let blob=new Blob([data],{type:"application/json"});
 let a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download=slot+"_campaign.json";
 a.click();
}

/* ---------- IMPORT ---------- */
function importCampaign(event){
 let file=event.target.files[0];
 if(!file)return;

 let reader=new FileReader();
 reader.onload=function(e){
   let slot=saveSlotSelect.value;
   localStorage.setItem(slot,e.target.result);
   alert("Imported into "+slot);
 };
 reader.readAsText(file);
}

/* ---------- LOAD NAMES ---------- */
let storedNames=localStorage.getItem("campaignNames");
if(storedNames){
 campaignNames=JSON.parse(storedNames);
}
initSlots();
updateUI();
renderLog();

/* ---------- PWA ---------- */
if('serviceWorker' in navigator){
 navigator.serviceWorker.register('sw.js');
}
</script>

</body>
</html>
